<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatAgentCore 管理后台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .platform-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .platform-card:hover { transform: translateY(-5px); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800">
    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 p-2 rounded-lg">
                    <i class="fas fa-robot text-white text-xl"></i>
                </div>
                <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                    ChatAgentCore
                </span>
            </div>
            <div id="system-status" class="flex items-center space-x-4">
                <div class="flex items-center space-x-2 px-3 py-1 bg-slate-100 rounded-full text-sm">
                    <span class="relative flex h-2 w-2">
                        <span id="agent-ping" class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span id="agent-dot" class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    <span id="agent-status-text" class="font-medium">uos-ai-assistant: 运行中</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-6xl mx-auto px-4 py-8">
        <header class="mb-10">
            <h1 class="text-3xl font-extrabold text-slate-900">机器人平台配置</h1>
            <p class="mt-2 text-slate-500 text-lg">配置并管理您的多平台聊天机器人接入信息</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- 飞书配置 -->
            <div class="platform-card bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center">
                                <i class="fab fa-feather-alt text-blue-500 text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg">飞书 (Feishu)</h3>
                                <span class="text-xs text-slate-400 uppercase tracking-wider">WebSocket 模式</span>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="feishu-enabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">App ID</label>
                            <input type="text" id="feishu-app_id" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none" placeholder="cli_xxx">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">App Secret</label>
                            <input type="password" id="feishu-app_secret" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none" placeholder="******">
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end">
                    <button onclick="saveConfig('feishu')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">保存配置</button>
                </div>
            </div>

            <!-- 钉钉配置 -->
            <div class="platform-card bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden opacity-90">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-sky-50 rounded-xl flex items-center justify-center">
                                <i class="fas fa-paper-plane text-sky-500 text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg">钉钉 (DingTalk)</h3>
                                <span class="text-xs text-slate-400 uppercase tracking-wider">Stream 模式</span>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="dingtalk-enabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">App Key</label>
                            <input type="text" id="dingtalk-app_key" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">App Secret</label>
                            <input type="password" id="dingtalk-app_secret" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none">
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end">
                    <button onclick="saveConfig('dingtalk')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">保存配置</button>
                </div>
            </div>

            <!-- QQ 机器人配置 -->
            <div class="platform-card bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center">
                                <i class="fab fa-qq text-slate-700 text-2xl"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-lg">QQ 机器人</h3>
                                <span class="text-xs text-slate-400 uppercase tracking-wider">OpenAPI</span>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="qq-enabled" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">App ID</label>
                            <input type="text" id="qq-app_id" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Token / Secret</label>
                            <input type="password" id="qq-token" class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none">
                        </div>
                    </div>
                </div>
                <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end">
                    <button onclick="saveConfig('qq')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors">保存配置</button>
                </div>
            </div>
        </div>

        <!-- 底部消息 -->
        <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 transform transition-all duration-300 opacity-0 translate-y-4">
            <div class="bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-xl flex items-center space-x-3">
                <i id="toast-icon" class="fas fa-check-circle text-green-400"></i>
                <span id="toast-message" class="font-medium">配置已保存</span>
            </div>
        </div>
    </main>

    <script>
        let fullConfig = {};

        async function init() {
            try {
                const response = await fetch('/api/config');
                fullConfig = await response.json();
                
                // 填充数据
                ['feishu', 'dingtalk', 'qq'].forEach(platform => {
                    const pConfig = fullConfig.platforms[platform];
                    if (pConfig) {
                        document.getElementById(`${platform}-enabled`).checked = pConfig.enabled;
                        for (let key in pConfig) {
                            const input = document.getElementById(`${platform}-${key}`);
                            if (input) input.value = pConfig[key] || '';
                        }
                    }
                });

                updateStatus();
                setInterval(updateStatus, 5000);
            } catch (error) {
                console.error('Failed to load config:', error);
                showToast('加载配置失败', 'error');
            }
        }

        async function updateStatus() {
            try {
                const response = await fetch('/api/config/status');
                const status = await response.json();
                
                const dot = document.getElementById('agent-dot');
                const ping = document.getElementById('agent-ping');
                const text = document.getElementById('agent-status-text');

                if (status.agent.running) {
                    dot.className = 'relative inline-flex rounded-full h-2 w-2 bg-green-500';
                    ping.className = 'animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75';
                    text.innerText = `uos-ai-assistant: 运行中 (PID: ${status.agent.pid})`;
                } else {
                    dot.className = 'relative inline-flex rounded-full h-2 w-2 bg-red-500';
                    ping.className = 'hidden';
                    text.innerText = `uos-ai-assistant: 已停止`;
                }
            } catch (error) {
                console.warn('Status check failed');
            }
        }

        async function saveConfig(platform) {
            const payload = {
                platforms: {
                    [platform]: {
                        enabled: document.getElementById(`${platform}-enabled`).checked
                    }
                }
            };

            // 提取输入框数据
            const inputs = document.querySelectorAll(`[id^="${platform}-"]`);
            inputs.forEach(input => {
                if (input.type !== 'checkbox') {
                    const key = input.id.replace(`${platform}-`, '');
                    payload.platforms[platform][key] = input.value;
                }
            });

            try {
                const response = await fetch('/api/config/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    showToast(`${platform} 配置保存成功`, 'success');
                } else {
                    const err = await response.json();
                    showToast(`保存失败: ${err.detail}`, 'error');
                }
            } catch (error) {
                showToast('网络请求失败', 'error');
            }
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-message');
            const iconEl = document.getElementById('toast-icon');

            msgEl.innerText = message;
            iconEl.className = type === 'success' 
                ? 'fas fa-check-circle text-green-400' 
                : 'fas fa-exclamation-circle text-red-400';

            toast.classList.remove('opacity-0', 'translate-y-4');
            toast.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
                toast.classList.remove('opacity-100', 'translate-y-0');
            }, 3000);
        }

        init();
    </script>
</body>
</html>