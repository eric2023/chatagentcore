# ChatAgentCore 架构设计阶段任务

**创建日期:** 2026-02-04
**状态:** ✅ 已完成
**优先级:** high
**完成日期:** 2026-02-04
**版本:** 2.0.0 (SDK 长连接版)

---

## 需求确认

| 项 | 确认内容 |
|----|---------|
| **平台接入顺序** | 飞书 → 企业微信 → 钉钉 |
| **部署环境** | 个人电脑，无需公网 IP（SDK 长连接方式） |
| **接口规范** | 采用通用统一接口规范 |
| **认证方式** | 可配置（默认固定 Token，可选 JWT） |
| **接入方式** | 官方 SDK 长连接 (SSE) |

---

## 技术方案决策

### 技术栈：Python 3.10+

| 决策 | 理由 |
|------|------|
| 语言选择 | 三大平台都有成熟 Python SDK，asyncio 原生异步支持，跨平台完整 |
| Web 框架 | FastAPI：高性能异步、自动 API 文档、原生 WebSocket |
| 配置管理 | Pydantic + YAML：类型安全、人性化格式、支持热加载 |
| 日志 | loguru：结构化日志、彩色输出 |
| 打包 | PyInstaller：单文件可执行程序 |
| 长连接方案 | 官方 SDK 长连接：无需公网 IP，部署简便 |

### 接口方式

| 用途 | 方式 |
|------|------|
| Qt → 中间服务 | HTTP POST（同步调用） |
| 中间服务 → Qt | WebSocket（异步推送） |
| 聊天平台 → 中间服务 | SDK 长连接 (SSE) - 官方 SDK 订阅事件 |

### 统一通用接口规范

```json
{
  "code": 0,
  "message": "success",
  "data": {},
  "timestamp": 1700000000
}
```

---

## 完成的工作

### 文档创建

| 文档 | 状态 | 位置 |
|------|------|------|
| 平台接入调研 | ✅ 已更新（SDK长连接版） | `docs/architecture/platform-research.md` |
| 系统架构设计 | ✅ 已重写（SDK长连接版） | `docs/architecture/system-design.md` |
| 开发规范 SOP | ✅ 已创建 | `docs/sop/chatagentcore-dev-skill.md` |

### README 更新

- ✅ 更新技术栈信息（Python + FastAPI）
- ✅ 添加快速开始指南
- ✅ 添加接口规范说明
- ✅ 添加配置说明（可配置认证方式）
- ✅ 添加平台接入计划
- ✅ 添加命令行 Demo 说明
- ✅ 更新变更记录（添加SDK长连接迁移）
- ✅ 添加验证步骤

### 架构亮点

1. ✅ 三大平台接入方式对比分析
2. ✅ 分层架构设计（接口层、核心服务层、适配层、数据层）
3. ✅ 插件化平台适配器设计
4. ✅ REST API + WebSocket 双接口模式
5. ✅ 事件总线机制支持实时消息推送
6. ✅ 配置驱动支持动态加载平台
7. ✅ 可配置认证方式（固定 Token / JWT）
8. ✅ SDK 长连接方式部署简便（无需公网 IP）
9. ✅ ASCII 架构图

---

## 系统架构概览（SDK 长连接方式）

```
                    ┌────────────────────────────────────────────────────────┐
                    │                      聊天平台层                         │
                    │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
                    │  │     飞书     │  │   企业微信   │  │     钉钉     │  │
                    │  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
                    └─────────┼─────────────────┼─────────────────┼──────────┘
                              │                 │                 │
                              │  SDK 长连接   │  SDK 长连接   │  SDK 长连接   │
                              │                 │                 │
                              └─────────────────┼─────────────────┘
                                                │
                    ┌───────────────────────────▼────────────────────────────┐
                    │                    接口层 (FastAPI)                     │
                    │  ┌──────────────────────┐  ┌──────────────────────┐    │
                    │  │  HTTP API Server     │  │  WebSocket Server    │    │
                    │  └──────────┬───────────┘  └──────────┬───────────┘    │
                    └─────────────┼───────────────────────────┼──────────────┘
                                  │                           │
                    ┌─────────────┼───────────────────────────┼──────────────┐
                    │             │      核心服务层          │              │
                    │  ┌──────────▼──────────┐  ┌────────────▼─────────────┐ │
                    │  │  Message Router     │  │     Event Bus           │ │
                    │  │  Config Manager     │  │   Adapter Manager       │ │
                    │  └─────────────────────┘  └────────────┬─────────────┘ │
                    └─────────────────────────────────────────┼───────────────┘
                                                              │
                    ┌─────────────────────────────────────────▼───────────────┐
                    │                    平台适配层                             │
                    │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
                    │  │  飞书适配器  │  │企业微信适配器│  │  钉钉适配器  │  │
                    │  │ (SDK长连接)  │  │  (SDK长连接)  │  │  (SDK长连接)  │  │
                    │  └──────────────┘  └──────────────┘  └──────────────┘  │
                    └───────────────────────────────────────────────────────────┘
                    │
                    │  HTTP POST / WebSocket
                    │
    ┌───────────────▼──────────────────────┐
    │            Qt AI 应用                 │
    │  • 问答能力引擎                       │
    │  • Skill 调用能力                     │
    └──────────────────────────────────────┘
```

---

## 待办事项（开发阶段）

| 任务 | 优先级 |
|------|--------|
| 企业微信适配器SDK长连接（第二阶段） | high |
| 钉钉适配器SDK长连接（第三阶段） | medium |

---

## 相关文档

- [平台接入调研（SDK 长连接版）](../docs/architecture/platform-research.md)
- [系统架构设计（SDK 长连接版）](../docs/architecture/system-design.md)
- [开发规范 SOP](../sop/chatagentcore-dev-skill.md)
- [飞书官方文档](https://open.feishu.cn/document)
- [企业微信官方文档](https://developer.work.weixin.qq.com)
- [钉钉官方文档](https://open.dingtalk.com)

---

## 下一步

✅ 架构设计阶段已完成，可进入企业微信/钉钉适配器开发阶段（SDK 长连接方式）。
