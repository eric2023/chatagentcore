# ChatAgentCore 开发阶段任务

**创建日期:** 2026-02-04
**状态:** ✅ 已完成
**完成日期:** 2026-02-04
**版本:** 2.0.0 (SDK 长连接版)
**优先级:** high

---

## 方案确认

| 项 | 内容 |
|----|---------|
| 开发方案 | 渐进式迭代开发（SDK 长连接模式） |
| 总阶段数 | 5 |
| 总步骤数 | 20 |
| 关键变更 | 迁移至 SDK 长连接方式，无需公网 IP |

---

## 阶段任务清单

### 阶段 1：基础框架

| 步骤 | ID | 状态 | 操作 | 原子操作 |
|------|----|------|------|---------|
| 1.1 | S1-01 | ✅ 已完成 | 创建目录结构 | 创建 core/, adapters/, api/, storage/, cli/, config/, tests/ 目录及子目录 |
| 1.2 | S1-02 | ✅ 已完成 | 初始化依赖管理 | 创建 pyproject.toml（定义项目元数据、依赖包括 lark_oapi） |
| 1.3 | S1-03 | ✅ 已完成 | 配置开发工具 | 创建 .editorconfig, .gitignore, .env.example |
| 1.4 | S1-04 | ✅ 已完成 | 配置基础日志 | 创建 storage/logger.py（loguru 配置） |
| 1.5 | S1-05 | ✅ 已完成 | 配置 Schema 定义 | 创建 api/schemas/config.py（Pydantic 设置模型，简化配置） |

**阶段 1 状态:** ✅ 已完成

---

### 阶段 2：核心服务层

| 步骤 | ID | 状态 | 操作 | 原子操作 |
|------|----|------|------|---------|
| 2.1 | S2-01 | ✅ 已完成 | 适配器基类 | 创建 adapters/base.py（抽象基类，定义 send_message，set_message_handler） |
| 2.2 | S2-02 | ✅ 已完成 | 事件总线 | 创建 core/event_bus.py（发布订阅机制，支持 channel 订阅） |
| 2.3 | S2-03 | ✅ 已完成 | 配置管理器 | 创建 core/config_manager.py（YAML 加载，热重载） |
| 2.4 | S2-04 | ✅ 已完成 | 适配器管理器 | 创建 core/adapter_manager.py（动态加载/卸载/重载适配器） |
| 2.5 | S2-05 | ✅ 已完成 | 消息路由 | 创建 core/router.py（路由到适配器，格式转换） |

**阶段 2 状态:** ✅ 已完成

---

### 阶段 3：接口层

| 步骤 | ID | 状态 | 操作 | 原子操作 |
|------|----|------|------|---------|
| 3.1 | S3-01 | ✅ 已完成 | 数据模型 | 创建 api/models/message.py（统一消息格式） |
| 3.2 | S3-02 | ✅ 已完成 | WebSocket 管理器 | 创建 api/websocket/manager.py（连接管理，消息推送） |
| 3.3 | S3-03 | ✅ 已完成 | API 路由 | 创建 api/routes/message.py（send, status, conversation, config） |
| 3.4 | S3-04 | ✅ 已完成 | FastAPI 应用 | 创建 api/main.py（初始化 app，注册路由，中间件） |
| 3.5 | S3-05 | ✅ 已完成 | 入口文件 | 创建 main.py（服务启动入口） |

**阶段 3 状态:** ✅ 已完成

---

### 阶段 4：飞书适配器（SDK 长连接）

| 步骤 | ID | 状态 | 操作 | 原子操作 |
|------|----|------|------|---------|
| 4.1 | S4-01 | ✅ 已完成 | 飞书数据模型 | 创建 adapters/feishu/models.py（消息、事件模型） |
| 4.2 | S4-02 | ✅ 已完成 | 飞书 SDK 长连接客户端 | 创建 adapters/feishu/client.py（官方SDK，SSE长连接订阅事件） |
| 4.3 | S4-03 | ✅ 已完成 | 飞书适配器实现 | 创建 adapters/feishu/__init__.py（继承 BaseAdapter，集成SDK） |

**阶段 4 状态:** ✅ 已完成

---

### 阶段 5：Demo 与测试

| 步骤 | ID | 状态 | 操作 | 原子操作 |
|------|----|------|------|---------|
| 5.1 | S5-01 | ✅ 已完成 | 配置示例 | 创建 config/config.yaml.example（简化版配置，无需webhook配置） |
| 5.2 | S5-02 | ✅ 已完成 | 命令行 Demo | 创建 cli/demo.py（send, status 命令示例） |
| 5.3 | S5-03 | ✅ 已完成 | SDK 验证脚本 | 创建 cli/verify_feishu_sdk.py（Token验证、连接测试） |
| 5.4 | S5-04 | ✅ 已完成 | 交互式测试工具 | 创建 cli/feishu_interactive.py（长连接监听+交互式回复） |
| 5.5 | S5-05 | ✅ 已完成 | 单元测试框架 | 创建 tests/conftest.py（pytest fixture） |
| 5.6 | S5-06 | ✅ 已完成 | 核心模块测试 | 创建 tests/unit/test_event_bus.py, test_config_manager.py |

**阶段 5 状态:** ✅ 已完成

---

## 总进度

| 阶段 | 完成度 |
|------|--------|
| 阶段 1：基础框架 | 5/5 ✅ |
| 阶段 2：核心服务层 | 5/5 ✅ |
| 阶段 3：接口层 | 5/5 ✅ |
| 阶段 4：飞书适配器 | 3/3 ✅ |
| 阶段 5：Demo 与测试 | 6/6 ✅ |
| **总计** | **24/24** ✅ |

---

## 交付成果

| 模块 | 文件 |
|------|------|
| 基础框架 | pyproject.toml, .editorconfig, .gitignore, storage/logger.py, api/schemas/config.py |
| 核心服务 | adapters/base.py, core/event_bus.py, core/config_manager.py, core/adapter_manager.py, core/router.py |
| 接口层 | api/models/message.py, api/websocket/manager.py, api/routes/message.py, api/main.py, main.py |
| 飞书适配器 | adapters/feishu/models.py, adapters/feishu/client.py (SDK长连接), adapters/feishu/__init__.py |
| Demo 测试 | config/config.yaml.example, cli/demo.py, cli/verify_feishu_sdk.py, cli/feishu_interactive.py, tests/conftest.py, tests/unit/test_event_bus.py, tests/unit/test_config_manager.py |

---

## 关键依赖

```toml
[dependencies]
fastapi = "^0.109"
uvicorn = {extras = ["standard"], version = "^0.27"}
pydantic = "^2.5"
pydantic-settings = "^2.1"
loguru = "^0.7"
pyyaml = "^6.0"
python-multipart = "^0.0.6"
httpx = "^0.25"
cryptography = "^41.0"
lark-oapi = "^1.2.0"  # 飞书官方 SDK（长连接）

[dev-dependencies]
pytest = "^7.4"
pytest-asyncio = "^0.23"
pytest-cov = "^4.1"
black = "^23.12"
ruff = "^0.1"
mypy = "^1.8"
```

---

## 使用说明

### 安装依赖

```bash
pip install -e .
```

### 配置文件

```bash
cp config/config.yaml.example config/config.yaml
# 编辑 config/config.yaml 填入实际配置
# 注意：长连接方式无需配置 webhook_base_url、verification_token 等
```

### 启动服务

```bash
python main.py --config config/config.yaml
```

### SDK 验证

```bash
# 验证飞书 SDK 连接
python cli/verify_feishu_sdk.py

# 交互式测试（长连接监听+回复）
python cli/feishu_interactive.py

# 发送单条消息
python cli/feishu_interactive.py --send --receive-id ou_xxxx --content "Hello"
```

### 命令行 Demo

```bash
# 发送消息
python cli/demo.py send --platform feishu --to user_id --message "Hello"

# 查询消息状态
python cli/demo.py status --platform feishu --message-id msg_123

# 健康检查
python cli/demo.py health
```

### 运行测试

```bash
pytest
```

---

## 相关文档

- [详细计划](../.claude/plan/dev-phase.md)
- [系统架构设计（SDK 长连接版）](../docs/architecture/system-design.md)
- [平台接入调研（SDK 长连接版）](../docs/architecture/platform-research.md)

---

**最后更新:** 2026-02-04
